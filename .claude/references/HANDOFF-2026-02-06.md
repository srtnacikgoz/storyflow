# Devir Teslim Notu - 6 Şubat 2026

> Bu dosya oturum arası bağlam aktarımı için oluşturulmuştur.
> Diğer bilgisayarda bu dosyayı oku ve kaldığın yerden devam et.

---

## ACIL: Deploy Edilmesi Gereken Değişiklikler

Aşağıdaki değişiklikler LOCAL'de hazır ama **henüz deploy edilmemiş**.
Production'da bu kodlar YOK, bu yüzden bardak eşleştirme ve pencere düzeltmesi çalışmıyor.

### Değişiklik Listesi (Uncommitted)

| Dosya | Durum | Ne Yapıyor |
|-------|-------|------------|
| `functions/src/orchestrator/orchestrator.ts` | Modified (+46 satır) | Beverage filtering: productType → tea/coffee → bardak tag eşleştirme |
| `functions/src/services/configService.ts` | Modified (+61 satır) | `getBeverageRulesConfig()` fonksiyonu + Firestore CRUD |
| `functions/src/orchestrator/types.ts` | Modified (+24 satır) | `BeverageType`, `BeverageRule` tipleri, Asset'e `defaultBeverage` alanı |
| `functions/src/orchestrator/seed/defaultData.ts` | Modified (+48 satır) | `DEFAULT_BEVERAGE_RULES` ve `DEFAULT_BEVERAGE_TAG_MAPPINGS` |
| `functions/src/orchestrator/geminiPromptBuilder.ts` | Modified | Business context: negatif kısıtlama yaklaşımına geçildi |
| `functions/src/controllers/orchestrator/beverageRulesController.ts` | **YENİ** | Beverage rules API endpoint'leri |
| `functions/src/controllers/orchestrator/index.ts` | Modified | beverageRules controller export |
| `functions/src/controllers/orchestratorController.ts` | Modified | beverageRules route bağlantısı |
| `admin/src/pages/Assets.tsx` | Modified | Tag schema UI kaldırıldı |
| `admin/src/services/api.ts` | Modified | Tag schema API çağrıları kaldırıldı |
| `admin/src/types/index.ts` | Modified | Tag schema tipleri kaldırıldı |
| `admin/src/components/StructuredTagForm.tsx` | **SİLİNDİ** | Tag schema formu kaldırıldı |
| `functions/src/controllers/orchestrator/tagSchemaController.ts` | **SİLİNDİ** | Tag schema controller kaldırıldı |

### Deploy Komutu

```bash
cd functions && npm run build && firebase deploy --only functions
```

Build test edildi, BAŞARILI (6 Şubat 2026).

---

## Düzeltilen 2 Sorun

### Sorun 1: Bardak Eşleştirmesi Çalışmıyor

**Belirti:** Kruvasan yanında çay olması gerekirken kahve geliyor.

**Kök Neden:** Beverage filtering kodu yazılmış ama deploy edilmemiş. Production'da bu kod yok, Gemini tüm bardaklardan rastgele seçiyor.

**Çözüm (kod hazır):** `orchestrator.ts:734-778` satırlarındaki beverage filtering logic'i:
```
productType (croissants) → getBeverageRulesConfig() → rules["croissants"].default = "tea"
→ tagMappings["tea"] = ["çay", "bitki çayı", ...] → bardakları filtrele → sadece çay bardaklarını Gemini'ye gönder
```

**Doğrulama:** Firestore'da "çay" etiketli 3+ bardak mevcut (EK6eeCf1cEpB, 2vW6Oxu9AqPt, zL4uGEmqNbZg).

### Sorun 2: Pencere Yanlış Kat Gösteriyor

**Belirti:** Zemin kat penceresi olması gerekirken üst kat gibi görünüyor.

**Kök Neden:** Business context (floorLevel: "ground") tamamen devre dışı bırakılmıştı (2026-02-03). Sebep: Tam ortam tarifi referans görsellerle çakışıyordu.

**Çözüm (kod hazır):** `geminiPromptBuilder.ts:1154-1201` - Ortam tarifi yerine sadece negatif kısıtlamalar ekleniyor:
```
ENVIRONMENT CONSTRAINTS:
- NO high-rise views, NO skyscraper backgrounds, NO aerial city views
- Window views must show street-level perspective (ground floor)
```
Bu yaklaşım referans görsellerle çakışmaz - Gemini'ye "yapma" der, "yap" demez.

---

## GitHub Araştırma Bulguları

### En Değerli Açık Kaynak Projeler

#### 1. Dynamic Prompts (Wildcard Sistemi)
- **Repo:** github.com/adieyal/dynamicprompts
- **Ne:** Jinja2 tabanlı parametrik prompt üretimi, 80K+ wildcard
- **Bizim için:** Senaryo + tema + kompozisyon tag'lerini wildcard gibi kullanma
- **Örnek:** `{__mevsimler__} ortamında {__ürünler__}` şablonları

#### 2. Gemini Image Prompting Handbook (JSON Schema)
- **Repo:** github.com/pauhu/gemini-image-prompting-handbook
- **Ne:** Gemini için JSON schema doğrulama çerçevesi
- **Etki:** Yapılandırılmış promptlar doğruluğu %60-80 artırıyor
- **Bizim için:** Prompt builder'ımızı formal JSON schema'ya evirmek

#### 3. Kiko FLUX2 Prompt Builder (Kamera Preset)
- **Repo:** github.com/ComfyAssets/kiko-flux2-prompt-builder
- **Ne:** JSON yapılı kamera/lens/ışık presetleri
- **Bizim için:** Composition alanımız `{ lens: "85mm", aperture: "f/2.8", angle: "45-degree" }` gibi yapılandırılmış veriye evrilebilir

#### 4. LangChain Social Media Agent (Reflection Döngüsü)
- **Repo:** github.com/langchain-ai/social-media-agent (2.2K yıldız)
- **Ne:** LangGraph ile modüler orkestrasyon, human-in-the-loop, öğrenme döngüsü
- **Bizim için:** Kullanıcı düzeltmelerinden prompt iyileştirme (reflection pattern)

#### 5. Creative Automation Pipeline (Marka Doğrulama)
- **Repo:** github.com/rudreshmehta/Creative-Automation-Pipeline
- **Ne:** Imagen 3 + OpenCV logo tespiti + K-means renk doğrulama
- **Bizim için:** Üretilen görsellerde marka tutarlılığı kontrolü

#### 6. Yahoo Photo Background Generation (Nesne Koruma)
- **Repo:** github.com/yahoo/photo-background-generation
- **Ne:** Ürün şeklini koruyarak arka plan üretimi (CVPR 2024)
- **Bizim için:** Ürün deforme olmadan sahne oluşturma referansı

### Instagram/Sosyal Medya Otomasyonları

| Proje | Yıldız | Dil | Öğrenilecek |
|-------|--------|-----|-------------|
| langchain-ai/social-media-agent | 2,200 | TS | Reflection döngüsü, interrupt() onay |
| David-patrick-chuks/Riona-AI-Agent | 4,200 | TS | Agent eğitim modülü |
| WillReynolds5/AutoGPT-Social | 340 | Python | Engagement feedback loop |
| rudreshmehta/Creative-Automation-Pipeline | yeni | Python | Marka uyumluluk doğrulama |
| Klaudiusz321/social-media-agents | 10 | Python | Multi-agent pattern, content pool |

### Prompt Mühendisliği Teknikleri

| Teknik | Etki | Kaynak |
|--------|------|--------|
| JSON yapılandırılmış schema | %60-80 doğruluk artışı | gemini-image-prompting-handbook |
| Negatif kısıtlamalar (constraints/avoid) | Kötü çıktılarda %50 azalma | AUTOMATIC1111, BackdropBoost |
| Kamera/lens preset sistemi | Kompozisyon tutarlılığı | Kiko, PromptForge |
| Stil enjeksiyon prefix'i | Marka tutarlılığı | z-Image ComfyUI |
| Prompt yaşam döngüsü izleme | Kalite kontrolü | Backblaze Prompt Flow |

---

## Yapılacaklar Listesi (Öncelik Sırasıyla)

### P0 - HEMEN (Deploy)
- [ ] `cd functions && npm run build && firebase deploy --only functions`
- [ ] Deploy sonrası test: "Şimdi Üret" ile kruvasan seç, bardak eşleşmesini kontrol et
- [ ] Deploy sonrası test: Pencerede zemin kat kısıtlamasının çalıştığını doğrula
- [ ] Commit at: `feat(beverage): bardak eşleştirme + pencere zemin kat kısıtlaması`

### P1 - KISA VADE (Bu Hafta)
- [ ] Beverage rules admin panel UI'ı ekle (kuralları admin'den yönetmek için)
- [ ] Alternate beverage logic: Her 3 paylaşımda 1 alternatif içecek (usageCount bazlı)
- [ ] Pipeline log'larında beverage filtering sonucunu görünür yap

### P2 - ORTA VADE (Araştırmadan)
- [ ] **JSON Yapılandırılmış Prompt Schema** - Prompt builder'ı formal JSON schema'ya çevir
  - scene, subjects, style, lighting, composition, constraints alanları
  - Referans: gemini-image-prompting-handbook
- [ ] **Negatif Kısıtlama Sistemi Genişlet** - Sadece floorLevel değil, tüm kurallar için
  - `constraints` alanı: `{ avoid: ["text", "watermarks", "cluttered"], require: ["street-level"] }`
- [ ] **Kamera Preset Sistemi** - Composition'ı yapılandırılmış veriye çevir
  - `{ lens: "85mm", angle: "45-degree overhead", depth: "shallow" }`
  - Referans: kiko-flux2-prompt-builder

### P3 - UZUN VADE (Araştırmadan)
- [ ] **Reflection/Öğrenme Döngüsü** - Kullanıcı düzeltmelerinden prompt iyileştirme
  - Onaylanmayan görsellerin sebeplerini kaydet
  - Onaylanan görsellerin ortak özelliklerini çıkar
  - Referans: langchain-ai/social-media-agent reflection graph
- [ ] **Engagement Feedback Loop** - Paylaşım sonrası metriklerle optimizasyon
  - Like/yorum sayılarını takip et
  - Başarılı görsellerin özelliklerini analiz et
  - Referans: AutoGPT-Social
- [ ] **Marka Uyumluluk Doğrulama** - Üretilen görselde otomatik kontrol
  - Renk paleti kontrolü (K-means clustering)
  - İstenmeyen öğe tespiti
  - Referans: Creative-Automation-Pipeline
- [ ] **Wildcard/Template Sistemi** - Prompt çeşitliliğini artır
  - Senaryo tag'leri → wildcard dosyaları
  - Referans: adieyal/dynamicprompts

---

## Stratejik Not

Araştırma sonucu: Bizim sistemimiz (senaryo + tema + kompozisyon + prop eşleştirme + beverage rules) **açık kaynak dünyasında benzersiz**. Hiçbir projede bu kadar katmanlı yaratıcı yönetim sistemi yok. En yakın olanlar metin bazlı sosyal medya otomasyonları.

Eksiklerimiz otomasyon ve öğrenme tarafında:
- Feedback loop (paylaşım sonrası metrikler)
- Reflection (kullanıcı düzeltmelerinden öğrenme)
- Marka doğrulama (üretilen görsel kontrolü)

Mevcut güçlü yanlarımız:
- Katmanlı orchestrator pipeline
- Beverage/prop eşleştirme (deploy sonrası aktif olacak)
- Senaryo/tema/kompozisyon sistemi
- Human-in-the-loop (Telegram onay)
