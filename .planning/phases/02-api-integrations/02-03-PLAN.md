---
phase: 02-api-integrations
plan: 03
type: execute
---

<objective>
DALL-E 3 API entegrasyonu ve görsel iyileştirme fonksiyonunun oluşturulması.

Purpose: Fotoğrafları AI ile iyileştirip, daha profesyonel ve çekici hale getirmek.
Output: Çalışan DALL-E 3 service, görsel enhancement fonksiyonu.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/AKILLI_ZAMANLAMA.md
@.planning/phases/02-api-integrations/02-02-SUMMARY.md
@functions/src/types/index.ts
@functions/src/config/constants.ts
@functions/src/services/openai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DALL-E 3 enhancement method ekle</name>
  <files>functions/src/services/openai.ts</files>
  <action>
    1. OpenAIService class'ına enhancePhoto() method ekle:
       - POST /images/generations
       - Model: dall-e-3 (constants.ts'den al)
       - Size: 1024x1024 (constants.ts'den DALLE_SIZE)
       - Quality: hd (constants.ts'den DALLE_QUALITY)
       - n: 1 (tek image)

    2. Prompt stratejisi (ÇAOK ÖNEMLİ!):
       Input parameters:
       - originalPhotoDescription: string (Vision API'den gelen analiz)
       - productCategory: ProductCategory (profiterol, chocolate, etc.)
       - productName?: string (opsiyonel, "Antep Fıstıklı Çikolata")

       Prompt template:
       ```
       Create a professional, high-quality food photography image of a {productCategory} from Sade Patisserie.

       Original photo analysis: {originalPhotoDescription}

       Enhancement requirements:
       - Premium, luxurious atmosphere
       - Professional studio lighting (soft, warm tones)
       - Rich, vibrant colors that look appetizing
       - Instagram-optimized composition
       - Editorial food photography style
       - Focus on the {productCategory}, clean background

       Specific to {productCategory}:
       [Kategori-özel talimatlar - viennoiserie vs pasta vs chocolate]

       Style: Gourmet food photography, editorial quality, hedonistic appeal
       ```

    3. Kategori-özel enhancement kuralları:
       - viennoiserie: "Golden, flaky texture, steam effect, morning light"
       - chocolate: "Glossy finish, rich cocoa tones, luxury feel"
       - profiterole: "Cream texture visible, chocolate drizzle, elegant presentation"
       - big-cakes: "Layered structure, decorative details, celebration mood"
       - slice-cakes: "Cross-section visible, texture detail, plating elegance"

    4. Response handling:
       - Return OpenAIImageResponse (url, revisedPrompt)
       - Enhanced image URL'i döndür
       - Firebase Storage'a upload etme (şimdilik URL yeterli)

    5. Error handling:
       - Content policy violation (unlikely for food)
       - Rate limit (429)
       - Image generation failed
       - Timeout (60 saniye - DALL-E yavaş)
  </action>
  <verify>
    - enhancePhoto() method eklendi
    - Kategori-özel prompt logic implement edildi
    - TypeScript compilation hatasız
    - Return type OpenAIImageResponse
  </verify>
  <done>DALL-E 3 enhancement fonksiyonu oluşturuldu</done>
</task>

<task type="auto">
  <name>Task 2: Enhancement prompt templates tanımla</name>
  <files>functions/src/config/constants.ts</files>
  <action>
    1. constants.ts'ye DALLE_ENHANCEMENT_PROMPTS ekle:
       - Base template (tüm ürünler için genel)
       - Kategori-spesifik templates:
         ```typescript
         export const DALLE_ENHANCEMENT_PROMPTS = {
           base: "Create a professional, high-quality food photography...",
           viennoiserie: "Golden, flaky texture, steam, morning light...",
           coffee: "Steam rising, rich crema, cozy atmosphere...",
           chocolate: "Glossy finish, rich cocoa, luxury feel...",
           "small-desserts": "Delicate details, vibrant colors, elegant...",
           "slice-cakes": "Cross-section, layers, texture detail...",
           "big-cakes": "Celebration mood, decorative, impressive...",
           profiterole: "Cream texture, chocolate drizzle, elegant...",
           "special-orders": "Unique design, artistic, premium quality..."
         };
         ```

    2. Prompt builder helper (util):
       - buildEnhancementPrompt() function
       - Parameters: category, analysis, productName
       - Returns: complete DALL-E prompt
       - Logic: base + category-specific + analysis insights

    3. Quality guidelines:
       - "food photography", "editorial style", "professional"
       - "Instagram-optimized", "appetizing", "luxurious"
       - Avoid: "fake", "artificial", "cartoon", "painting"
  </action>
  <verify>
    - DALLE_ENHANCEMENT_PROMPTS constant tanımlı
    - Her kategori için template var
    - buildEnhancementPrompt() helper oluşturuldu (utils'de)
  </verify>
  <done>Enhancement prompt templates hazır</done>
</task>

<task type="auto">
  <name>Task 3: Test function ve final dokümantasyon</name>
  <files>functions/src/index.ts, README.md, functions/src/utils/promptBuilder.ts</files>
  <action>
    1. utils/promptBuilder.ts oluştur:
       - buildEnhancementPrompt() function implement et
       - Export from utils/index.ts

    2. functions/src/index.ts'ye test function ekle:
       - testImageEnhancement function (HTTP trigger)
       - Parameters: imageUrl, category (query params)
       - Full pipeline test:
         a. Vision API ile analiz
         b. DALL-E 3 ile enhancement
         c. Her iki sonucu da response'da döndür
       - Response format:
         ```json
         {
           "original": "https://...",
           "analysis": "...",
           "enhanced": "https://...",
           "prompt": "..."
         }
         ```

    3. README.md güncelle - "Full Pipeline Test" section:
       - Tüm API'lerin birlikte test edilmesi
       - Expected cost: ~$0.09 per test (Vision $0.01 + DALL-E $0.08)
       - Test için örnek image URL'ler
       - Curl örneği:
         ```bash
         curl "https://europe-west1-instagram-automation-ad77b.cloudfunctions.net/testImageEnhancement?imageUrl=https://example.com/photo.jpg&category=chocolate"
         ```

    4. Cost summary dokümantasyonu:
       - Vision analysis: $0.01 per photo
       - DALL-E 3 enhancement: $0.08 per photo
       - Instagram post: FREE
       - **Total per post: ~$0.09**
       - Günde 1 post: ~$2.70/ay
       - Firebase: ~$2.60/ay
       - **TOTAL: ~$5.30/ay** ✓ (Budget dahilinde)

    5. .env.example final kontrol:
       - Tüm API key'ler dokümante
       - Setup instructions complete
  </action>
  <verify>
    - promptBuilder.ts oluşturuldu
    - testImageEnhancement function çalışıyor
    - README.md full pipeline section var
    - Cost summary dokümante
    - npm run build hatasız
    - npm run lint hatasız
  </verify>
  <done>Test function hazır, dokümantasyon complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] enhancePhoto() method implement edildi
- [ ] Kategori-spesifik prompt templates tanımlandı
- [ ] buildEnhancementPrompt() helper oluşturuldu
- [ ] Test function (testImageEnhancement) hazır
- [ ] Full pipeline test edilebilir
- [ ] npm run build hatasız
- [ ] npm run lint hatasız
- [ ] Cost analysis dokümante
- [ ] README.md complete
</verification>

<success_criteria>
- Tüm tasklar tamamlandı
- DALL-E 3 service implement edildi
- Enhancement prompts kategori-spesifik
- Full pipeline test edilebilir (Vision + DALL-E + Instagram ready)
- Error handling comprehensive
- Dokümantasyon complete
- Phase 2 complete: All APIs integrated
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-integrations/02-03-SUMMARY.md`:

# Phase 2 Plan 3: DALL-E 3 API Integration Summary

**DALL-E 3 API entegre edildi, görsel enhancement sistemi hazır**

## Accomplishments
- DALL-E 3 enhancement fonksiyonu oluşturuldu
- Kategori-spesifik prompt templates (8 kategori)
- Prompt builder utility
- Full pipeline test function
- Cost analysis tamamlandı

## Files Created/Modified
- `functions/src/services/openai.ts` - DALL-E 3 method eklendi
- `functions/src/config/constants.ts` - Enhancement prompt templates
- `functions/src/utils/promptBuilder.ts` - Prompt builder helper
- `functions/src/utils/index.ts` - Utils exports
- `functions/src/index.ts` - Full pipeline test function
- `README.md` - Complete API documentation

## Decisions Made
- DALL-E 3 HD quality kullanımı
- 1024x1024 image size
- Kategori-spesifik enhancement stratejisi
- 60 saniye timeout (generation time)
- Cost: ~$0.09 per enhanced post

## Issues Encountered
[Karşılaşılan sorunlar veya "None"]

## Cost Analysis
- Vision: $0.01/photo
- DALL-E 3: $0.08/photo
- Instagram: FREE
- Firebase: ~$2.60/ay
- **Total: ~$5.30/ay** ✓ Budget OK

## Next Step
**Phase 2 Complete!** Ready for Phase 3: Automation Pipeline
- Firestore kuyruk sistemi
- Orchestration fonksiyonu
- Pub/Sub scheduler
</output>
