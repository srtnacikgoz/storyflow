---
phase: 02-api-integrations
plan: 02
type: execute
---

<objective>
OpenAI Vision API entegrasyonu ve fotoğraf analiz fonksiyonunun oluşturulması.

Purpose: Fotoğrafları AI ile analiz edip, iyileştirme için insight'lar elde etmek.
Output: Çalışan OpenAI Vision service, fotoğraf analiz fonksiyonu.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/02-api-integrations/02-01-SUMMARY.md
@functions/src/types/index.ts
@functions/src/config/constants.ts
@functions/src/config/environment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OpenAI service modülü oluştur (Vision kısmı)</name>
  <files>functions/src/services/openai.ts</files>
  <action>
    1. functions/src/services/openai.ts oluştur:
       - OpenAI API base URL: https://api.openai.com/v1
       - OpenAIService class oluştur
       - Constructor'da config'den apiKey al
       - Private helper methods:
         - getHeaders() - Authorization + Content-Type headers
         - handleError() - API error handling (rate limit, invalid key, etc.)

    2. analyzePhoto() method (Vision API):
       - POST /chat/completions
       - Model: gpt-4-vision-preview (constants.ts'den al)
       - Messages format:
         ```typescript
         [{
           role: "user",
           content: [
             { type: "text", text: "Analyze this Sade Patisserie product photo..." },
             { type: "image_url", image_url: { url: photoUrl } }
           ]
         }]
         ```
       - max_tokens: 300 (yeterli analiz için)
       - Prompt stratejisi:
         "Bu Sade Patisserie ürün fotoğrafını analiz et. Şunları değerlendir:
         1. Işık ve aydınlatma kalitesi
         2. Ürünün görsel çekiciliği
         3. Renk paletinin zenginliği
         4. Kompozisyon ve düzenleme
         5. Instagram için görsel iyileştirme önerileri
         Kısa ve öz analiz yap (3-4 cümle)."

    3. Return OpenAIVisionResponse:
       - analysis: string (AI'ın analizi)
       - suggestions: string (iyileştirme önerileri)

    4. Error handling:
       - Invalid API key
       - Rate limit exceeded (429)
       - Image URL not accessible
       - Model overloaded (503)
       - Timeout (30 saniye)
  </action>
  <verify>
    - functions/src/services/openai.ts mevcut
    - OpenAIService class export ediliyor
    - analyzePhoto() method signature doğru
    - TypeScript compilation hatasız
  </verify>
  <done>OpenAI Vision service modülü oluşturuldu</done>
</task>

<task type="auto">
  <name>Task 2: Test function ve service export</name>
  <files>functions/src/services/index.ts, functions/src/index.ts</files>
  <action>
    1. functions/src/services/index.ts güncelle:
       - export * from './openai';

    2. functions/src/index.ts'ye test function ekle:
       - testVisionAnalysis function (HTTP trigger)
       - Parameters: imageUrl (query param)
       - OpenAIService.analyzePhoto() çağır
       - Response: Analysis result JSON

    3. Error handling test:
       - Invalid image URL
       - API key missing (config validation)
       - Network timeout

    4. Build test et
  </action>
  <verify>
    - services/index.ts'de openai export var
    - npm run build hatasız
    - testVisionAnalysis function export edilmiş
    - Error cases handle ediliyor
  </verify>
  <done>Service export güncellendi, test function hazır</done>
</task>

<task type="auto">
  <name>Task 3: Prompt optimization ve dokümantasyon</name>
  <files>functions/src/config/constants.ts, README.md</files>
  <action>
    1. constants.ts'ye Vision prompt templates ekle:
       - VISION_ANALYSIS_PROMPT: Detaylı analiz prompt'u
       - Prompt'ta şunlar olmalı:
         * "Sade Patisserie" context
         * Ürün tipi awareness (viennoiserie vs pasta vs çikolata)
         * Instagram için optimize edilmiş analiz
         * Türkçe output

    2. README.md'ye "OpenAI API Setup" section ekle:
       - OpenAI account oluşturma
       - API key alma (https://platform.openai.com/api-keys)
       - Billing setup (credit card gerekli)
       - Usage limits ve pricing ($0.01 per image for GPT-4 Vision)
       - Firebase config'e ekleme:
         ```bash
         firebase functions:config:set openai.api_key="sk-..."
         ```

    3. .env.example güncelle:
       - OpenAI API key format
       - Example: OPENAI_API_KEY=sk-proj-...

    4. Cost estimation:
       - GPT-4 Vision: ~$0.01 per analysis
       - Günde 1 analiz: ~$0.30/ay
       - Note: DALL-E daha pahalı olacak (~$0.08 per image)
  </action>
  <verify>
    - constants.ts'de VISION_ANALYSIS_PROMPT var
    - README.md'de OpenAI setup section var
    - .env.example güncel
    - Cost estimation dokümante
  </verify>
  <done>Prompt templates eklendi, dokümantasyon tamamlandı</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] OpenAIService class oluşturuldu
- [ ] analyzePhoto() method implement edildi
- [ ] Test function (testVisionAnalysis) hazır
- [ ] Prompt templates tanımlandı
- [ ] npm run build hatasız
- [ ] npm run lint hatasız
- [ ] Dokümantasyon güncel
</verification>

<success_criteria>
- Tüm tasklar tamamlandı
- OpenAI Vision service modülü çalışıyor
- Fotoğraf analiz fonksiyonu hazır
- Error handling comprehensive
- Test function deploy edilebilir
- Prompt optimization yapılmış
- Cost estimation dokümante
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-integrations/02-02-SUMMARY.md`:

# Phase 2 Plan 2: OpenAI Vision API Integration Summary

**OpenAI Vision API entegre edildi, fotoğraf analiz fonksiyonu hazır**

## Accomplishments
- OpenAI Vision API client oluşturuldu
- Fotoğraf analiz fonksiyonu (analyzePhoto)
- Sade Patisserie'ye özel prompt template
- Test function eklendi

## Files Created/Modified
- `functions/src/services/openai.ts` - OpenAI service (Vision)
- `functions/src/services/index.ts` - Service exports
- `functions/src/index.ts` - Test function
- `functions/src/config/constants.ts` - Vision prompt templates
- `README.md` - OpenAI API setup guide
- `.env.example` - OpenAI key format

## Decisions Made
- GPT-4 Vision Preview model kullanımı
- max_tokens: 300 (analiz için yeterli)
- Türkçe prompt ve output
- 30 saniye timeout

## Issues Encountered
[Karşılaşılan sorunlar veya "None"]

## Next Step
Ready for 02-03-PLAN.md (DALL-E 3 API Integration)
</output>
