---
phase: 02-api-integrations
plan: 01
type: execute
---

<objective>
Instagram Graph API entegrasyonu ve test post fonksiyonunun oluşturulması.

Purpose: Instagram'a otomatik post paylaşabilmek için API bağlantısını kurmak.
Output: Çalışan Instagram service modülü, test edilmiş post fonksiyonu.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-setup/01-02-SUMMARY.md
@functions/src/types/index.ts
@functions/src/config/environment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instagram service modülü oluştur</name>
  <files>functions/src/services/instagram.ts</files>
  <action>
    1. functions/src/services/instagram.ts oluştur:
       - Instagram Graph API base URL: https://graph.instagram.com/v18.0
       - InstagramService class oluştur
       - Constructor'da config'den accountId ve accessToken al
       - Private helper methods:
         - getHeaders() - Authorization header oluştur
         - handleError() - API error handling

    2. createMediaContainer() method:
       - POST /{account-id}/media
       - Parameters: image_url, caption
       - Returns: container_id (creation_id)
       - Error handling: Token expired, rate limit, invalid image URL

    3. publishMedia() method:
       - POST /{account-id}/media_publish
       - Parameters: creation_id
       - Returns: media_id (Instagram post ID)
       - Error handling: Publishing failed, container not ready

    4. createPost() public method (ana fonksiyon):
       - İki aşamalı süreç: container create → publish
       - Parameters: imageUrl, caption
       - Returns: InstagramPost object
       - Logging: Her aşamayı logla
       - Retry logic YOK (manual retry, Firebase Functions zaten retry eder)

    5. getMediaInfo() helper method (opsiyonel, debug için):
       - GET /{media-id}
       - Returns: media details (permalink, timestamp, etc.)
  </action>
  <verify>
    - functions/src/services/instagram.ts mevcut
    - InstagramService class export ediliyor
    - TypeScript compilation hatasız
    - createPost() method signature doğru
  </verify>
  <done>Instagram service modülü oluşturuldu, API methods tanımlandı</done>
</task>

<task type="auto">
  <name>Task 2: Service barrel export güncelle</name>
  <files>functions/src/services/index.ts</files>
  <action>
    1. functions/src/services/index.ts güncelle:
       - export * from './instagram';
       - Şimdilik OpenAI export'ları comment'le (henüz yok)

    2. functions/src/index.ts'ye test function ekle:
       - testInstagramPost function (HTTP trigger)
       - Parameters: imageUrl (query param)
       - Test caption oluştur
       - InstagramService.createPost() çağır
       - Response: Success/error

    3. Build test et
  </action>
  <verify>
    - services/index.ts'de instagram export var
    - npm run build hatasız
    - index.ts'de testInstagramPost export edilmiş
  </verify>
  <done>Service export güncellendi, test function hazır</done>
</task>

<task type="auto">
  <name>Task 3: Environment variables dokümante et</name>
  <files>.env.example, README.md</files>
  <action>
    1. .env.example'a Instagram setup talimatları ekle:
       - Instagram Business Account gerekli
       - Access Token nasıl alınır (adım adım)
       - Account ID nereden bulunur
       - Token süre dolumu (60 gün)

    2. README.md'ye "Instagram API Setup" section ekle:
       - Meta Business Suite'e giriş
       - Instagram Business Account bağlama
       - Facebook App oluşturma
       - instagram_basic permissions
       - Long-lived token alma (60 gün)
       - Firebase config'e ekleme komutları

    3. Dokümantasyonda örnekler:
       ```bash
       # Instagram Account ID bulma
       curl "https://graph.instagram.com/v18.0/me?fields=id,username&access_token=YOUR_TOKEN"

       # Token test etme
       curl "https://graph.instagram.com/v18.0/{account-id}?fields=id,username&access_token=YOUR_TOKEN"

       # Firebase config'e ekleme
       firebase functions:config:set instagram.account_id="17841..." instagram.access_token="EAAxx..."
       ```
  </action>
  <verify>
    - .env.example güncel Instagram talimatları içeriyor
    - README.md'de Instagram API Setup section var
    - Örnekler çalışır durumda (curl komutları)
  </verify>
  <done>Instagram API setup dokümantasyonu tamamlandı</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] InstagramService class oluşturuldu
- [ ] createPost() method implement edildi
- [ ] Test function (testInstagramPost) hazır
- [ ] npm run build hatasız
- [ ] npm run lint hatasız (veya tolerable warnings)
- [ ] Dokümantasyon güncel
</verification>

<success_criteria>
- Tüm tasklar tamamlandı
- Instagram service modülü çalışıyor
- API methods tanımlandı (createMediaContainer, publishMedia, createPost)
- Test function deploy edilebilir
- Dokümantasyon güncel ve açık
- TypeScript strict mode uyumlu
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-integrations/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Instagram Graph API Integration Summary

**Instagram Graph API service modülü oluşturuldu ve test edilmeye hazır**

## Accomplishments
- Instagram Graph API client oluşturuldu
- İki aşamalı post mekanizması (container → publish)
- Test function eklendi
- API dokümantasyonu tamamlandı

## Files Created/Modified
- `functions/src/services/instagram.ts` - Instagram API service
- `functions/src/services/index.ts` - Service exports
- `functions/src/index.ts` - Test function
- `.env.example` - Instagram setup guide
- `README.md` - API kurulum talimatları

## Decisions Made
- Instagram Graph API v18.0 kullanımı
- İki aşamalı post sürecin (container create → publish)
- Error handling stratejisi
- Test function eklemesi (manual test için)

## Issues Encountered
[Karşılaşılan sorunlar veya "None"]

## Next Step
Ready for 02-02-PLAN.md (OpenAI Vision API Integration)
</output>
