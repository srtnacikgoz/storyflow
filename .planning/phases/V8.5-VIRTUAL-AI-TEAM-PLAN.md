# Milestone v8.5: Virtual AI Team - Uygulama Planı

> **Oluşturulma:** 2026-01-26
> **Durum:** Onaylandı - Kodlamaya hazır
> **Kaynak:** Claude planı + Gemini eleştiri/önerileri entegre edildi

---

## Özet

Mevcut pipeline'a 4 yeni yetenek ekleyerek "sanal AI ekibi" oluşturma:

| Phase | Konu | Zorluk |
|-------|------|--------|
| Phase 1 | Config-Driven Prompts (Prompt Studio) | Orta |
| Phase 2 | Asset Pre-Flight Check | Kolay-Orta |
| Phase 3 | Enhanced QC with Reference Comparison | Orta-Zor |
| Phase 4 | Automatic Log Analysis | Orta |

---

## Bağımlılık Sırası (Gemini Önerisi ile Güncellenmiş)

```
Phase 1 (Prompt Studio) ──┐
                           ├──→ Phase 3 (Enhanced QC) ──→ Phase 4 (Log Analysis)
Phase 2 (Pre-Flight) ─────┘
```

> **Gemini Notu:** Phase 2 (Prompt Studio) en başa alındı. Çünkü Phase 3-4'ün promptlarını
> yazarken koda gömmek yerine Prompt Studio'da canlı denemeler yapılabilir.
> Phase 1 + Phase 2 yine paralel yapılabilir ama öncelik Prompt Studio'da.

---

## Gerçekçi Maliyet Analizi (Gemini Düzeltmesi)

> **Orijinal tahmin:** ~$2.14/ay (100 post)
> **Gemini düzeltmesi:** ~$17-20/ay (3 deneme = 1 başarılı post kuralı dahil)

| Phase | İyimser (1 deneme) | Gerçekçi (3 deneme) | 100 Post |
|-------|--------------------|---------------------|----------|
| Pre-Flight (Haiku) | ~$0.001 | ~$0.003 | ~$0.30 |
| Prompt Studio | $0 | $0 | $0 |
| Enhanced QC (full) | ~$0.02 | ~$0.05 | ~$15.00 |
| Log Analysis (haftalık) | ~$0.01/hafta | ~$0.10/hafta | ~$0.40 |
| **TOPLAM** | | | **~$15-20/ay** |

> Hala bir ajans maliyetinden çok daha ucuz, ama planın orijinal tahminine göre ~10x.

---

## PHASE 1: Config-Driven Prompts (Prompt Studio)

### Amaç

`claudeService.ts`'deki 5 hardcoded system prompt'u Firestore'a taşıyarak deploy gerekmeden
düzenlenebilir yapmak.

### Taşınacak Prompt'lar

| Prompt | claudeService.ts Satırları | Stage |
|--------|---------------------------|-------|
| Asset Selection | 156-185 | `selectAssets()` |
| Scenario Selection | 531-549 | `selectScenario()` |
| Prompt Optimization | 1105-1162 | `optimizePrompt()` |
| Quality Control | 743-761 | `evaluateImage()` |
| Content Generation | 966-987 | `generateContent()` |

### Yeni Dosyalar

| Dosya | Açıklama |
|-------|----------|
| `admin/src/pages/PromptStudio.tsx` | Prompt düzenleme sayfası |
| `functions/src/orchestrator/seed/promptStudioDefaults.ts` | Mevcut prompt'ların seed datası |

### Değişecek Dosyalar

| Dosya | Değişiklik |
|-------|------------|
| `functions/src/services/configService.ts` | `getPromptTemplate()` + 5dk cache + **invalidation hook** |
| `functions/src/orchestrator/claudeService.ts` | 5 fonksiyondaki hardcoded prompt → `getPromptTemplate()` + `interpolatePrompt()` helper |
| `functions/src/orchestrator/types.ts` | `PromptStudioConfig`, `PromptTemplate`, `PromptVersion` interface'leri |
| `functions/src/controllers/orchestrator/configController.ts` | 5 endpoint: CRUD + versiyon geçmişi + revert |
| `functions/src/orchestrator/orchestrator.ts` | Pipeline result'a `promptVersions` kaydı |
| `admin/src/App.tsx` | `/prompt-studio` route |
| `admin/src/components/Sidebar.tsx` | Menü öğesi |
| `admin/src/services/api.ts` | Prompt Studio API metodları |

### Firestore Schema

```
global/config/settings/prompt-studio
├── prompts
│   ├── asset-selection: { systemPrompt, version, variables[], history[] }
│   ├── scenario-selection: { ... }
│   ├── prompt-optimization: { ... }
│   ├── quality-control: { ... }
│   └── content-generation: { ... }
└── updatedAt
```

### Kritik Tasarım Kararları

- **Fallback:** Firestore'dan okunamazsa hardcoded prompt kullanılır (geriye uyumluluk)
- **Template değişkenler:** `{{mood}}`, `{{timeOfDay}}` şeklinde, `interpolatePrompt()` ile çözümlenir
- **Versiyon takibi:** Her güncelleme otomatik `version++`, history dizisine kaydeder
- **Pipeline kayıt:** Hangi prompt versiyonu hangi görseli üretti → `ai-logs`'a kaydedilir

### Gemini Eklentisi: Cache Invalidation

> **Sorun:** 5dk cache varken prompt değişikliği anında yansımaz.
> **Çözüm:** Admin panelde "Cache Temizle" butonu veya config güncellenince otomatik
> `clearPromptCache()` çağrısı. (`configController` update endpoint'ine eklenir)

### Test Stratejisi

- [ ] Mevcut hardcoded prompt'ları seed et → pipeline'ın aynı sonucu ürettiğini doğrula
- [ ] Firestore'daki prompt'u değiştir → cache sonrası yeni prompt'un kullanıldığını doğrula
- [ ] Firestore erişim hatası → fallback prompt'un devreye girmesini test et
- [ ] Cache invalidation → anlık güncellemeyi doğrula
- [ ] `npm run build` başarılı

---

## PHASE 2: Asset Pre-Flight Check

### Amaç

Pipeline başlamadan önce asset metadata'larının eksiksiz olduğunu doğrula.
"Siyah metal masa → ahşap masa" bug'ının kökünden önlenmesi.

### Yeni Dosyalar

| Dosya | Açıklama |
|-------|----------|
| `functions/src/services/assetValidator.ts` | Validasyon servisi |

### Değişecek Dosyalar

| Dosya | Değişiklik |
|-------|------------|
| `functions/src/orchestrator/types.ts` | `AssetHealthReport`, `AssetHealthIssue` interface'leri |
| `functions/src/controllers/orchestrator/configController.ts` | 3 endpoint: `getAssetHealth`, `runAssetHealthCheck`, `getAssetHealthDetail` |
| `functions/src/orchestrator/orchestrator.ts` | Pre-flight check (loadAvailableAssets sonrası) |
| `admin/src/services/api.ts` | Asset health API metodları |
| `admin/src/pages/Assets.tsx` | Health banner + asset kartlarında sağlık ikonları |

### Detay

- **Kategori bazlı zorunlu alan kontrolü:**
  - `furniture` → material + style zorunlu
  - `plates` → material + style + colors zorunlu
  - vb.
- **Pipeline entegrasyonu:** `system-settings`'e `preFlightMode` eklenir:
  - `"warn"` → logla, devam et
  - `"strict"` → durdur
  - `"off"` → atla
- **Admin UI:** Assets sayfasına yeşil/sarı/kırmızı health banner, asset kartlarına sağlık noktası

### Test Stratejisi

- [ ] Boş material alanı olan test asset'i → validator'ın yakalayıp yakalamadığını kontrol et
- [ ] Pre-flight "strict" modda → pipeline durduğunu doğrula
- [ ] Admin'de health banner'ın doğru renkte göründüğünü kontrol et
- [ ] `npm run build` başarılı

---

## PHASE 3: Enhanced QC with Reference Comparison

### Amaç

QC aşamasında sadece ürün değil, TÜM referans görselleri (tabak, masa, fincan, peçete, çatal)
göndererek malzeme/renk/şekil uyumsuzluğu tespiti.

### Değişecek Dosyalar

| Dosya | Değişiklik |
|-------|------------|
| `functions/src/orchestrator/claudeService.ts` | `evaluateImage()` imzasına `referenceAssets` parametresi + system prompt güncelleme |
| `functions/src/orchestrator/types.ts` | `QualityControlResult`'a `assetFidelity` alanı |
| `functions/src/orchestrator/orchestrator.ts` | QC çağrısına referans görselleri ekleme |

### QC Response Yeni Yapısı (Gemini Düzeltmesi ile)

```typescript
// Gemini önerisi: Record<string, AssetFidelityReport> kullan
// Tek ürün değil, çoklu ürün (kahve + kruvasan) desteği için
assetFidelity: Record<string, {
  score: number;       // 1-10
  issues: string[];    // Tespit edilen sorunlar
  referenceUsed: boolean;
}>

// Örnek:
{
  "product_baklava": { score: 8, issues: [], referenceUsed: true },
  "plate_beyaz-porselen": { score: 9, issues: [], referenceUsed: true },
  "table_ahsap-masa": { score: 3, issues: ["Malzeme yanlış: metal yerine ahşap görünüyor"], referenceUsed: true },
  "cup_espresso": { score: 10, issues: [], referenceUsed: false }
}
```

### Maliyet Kontrolü (Gemini: Smart Modu Baştan Kur)

`system-settings`'e `qcReferenceMode` eklenir:

| Mod | Açıklama | Ek Maliyet |
|-----|----------|------------|
| `"full"` | Tüm referansları gönder (en doğru, en pahalı) | ~$0.05/pipeline |
| `"product-only"` | Sadece ürün (mevcut davranış) | $0 |
| `"smart"` | Pre-Flight'tan yeşil geçen asset'lerin referansını gönderme | ~$0.02/pipeline |

> **Gemini Notu:** "Smart" modu en baştan implemente et. Pre-Flight'tan metadata'sı tam olan
> asset'leri QC'ye referans olarak göndermeye gerek yok - token tasarrufu sağlar.

### Test Stratejisi

- [ ] Bilinen "yanlış malzeme" görseli ile QC → `assetFidelity.table.score` düşük çıkmalı
- [ ] Doğru görselle QC → tüm skorlar yüksek olmalı
- [ ] `qcReferenceMode` değiştirerek maliyet karşılaştırması yap
- [ ] Çoklu ürün senaryosunda `Record<string, ...>` yapısını doğrula
- [ ] `npm run build` başarılı

---

## PHASE 4: Automatic Log Analysis

### Amaç

Pipeline çalıştıktan sonra `ai-logs` collection'ından pattern analizi yaparak haftalık rapor oluşturma.

### Model Seçimi (Gemini Düzeltmesi)

> **Orijinal plan:** Claude Haiku 4.5 ($1/$5 MTok) - bu model mevcut değil.
> **Gemini önerisi:** Log analizi için **Gemini 1.5 Flash** kullan.
> - Google Cloud ekosisteminde kalırsın
> - Maliyet $0.01'in altında
> - JSON analizi için fazlasıyla yeterli
> - `system-settings`'e `logAnalysisModel` alanı eklenerek değiştirilebilir

### Yeni Dosyalar

| Dosya | Açıklama |
|-------|----------|
| `functions/src/services/logAnalysisService.ts` | Log analiz servisi |
| `admin/src/pages/LogAnalysis.tsx` | Analiz dashboard (veya AIMonitor'a tab) |

### Değişecek Dosyalar

| Dosya | Değişiklik |
|-------|------------|
| `functions/src/orchestrator/types.ts` | `LogAnalysisReport` interface |
| `functions/src/orchestrator/scheduler.ts` | Haftalık analiz schedule (Pazartesi 09:00) |
| `functions/src/controllers/orchestrator/configController.ts` | 3 endpoint: latest, run, history |
| `admin/src/services/api.ts` | Log analysis API metodları |

### Analiz Kapsamı

1. **Tekrarlayan hatalar:** Hangi stage'de sürekli fail oluyor?
2. **Asset metadata boşlukları:** Hangi asset'ler sorun yaratıyor?
3. **Prompt etkinliği:** Hangi prompt versiyonu daha yüksek QC skoru alıyor? (Phase 1 ile entegre)
4. **Maliyet trendi:** Pipeline başına ortalama maliyet, regeneration oranı

### Test Stratejisi

- [ ] Yapay log verisi oluştur → recurring failure tespitini doğrula
- [ ] Rapor Firestore'a kaydedildiğini doğrula
- [ ] Admin UI'da raporun görüntülenmesini kontrol et
- [ ] `npm run build` başarılı

---

## Gemini'den Ek Mimari Notlar

### 1. Multi-Product Desteği
Plan "Single Product" varsayımıyla gidiyor. Yarın "Kahve + Kruvasan" aynı karede olsun
dendiğinde `assetFidelity` yapısının Array olarak dönmesi gerekecek.
**Çözüm:** `types.ts` güncellenirken `Record<string, AssetFidelityReport>` kullan.

### 2. Cache Invalidation Hook
Phase 1'de 5dk cache harika ama anlık güncelleme istendiğinde:
- Admin panelde "Cache Temizle" butonu
- VEYA config endpoint'inde update sonrası otomatik `clearPromptCache()`

### 3. Log Analysis Model Seçimi
Pahalı Claude modeli yerine Gemini 1.5 Flash:
- JSON analizi için yeterli
- Google Cloud ekosisteminde
- Maliyet: <$0.01/analiz

---

## Genel Doğrulama Stratejisi

- Her phase sonrası `npm run build` başarılı olmalı
- Firebase deploy sonrası mevcut pipeline'ın bozulmadığını doğrula
- Her phase bağımsız commit'lenecek
- Phase 1-2 paralel yapılabilir, Phase 3 ikisinden sonra, Phase 4 en son

---

## İlerleme Takibi

| Phase | Durum | Başlangıç | Bitiş |
|-------|-------|-----------|-------|
| Phase 1: Prompt Studio | ⏳ Bekliyor | - | - |
| Phase 2: Pre-Flight | ⏳ Bekliyor | - | - |
| Phase 3: Enhanced QC | ⏳ Bekliyor | - | - |
| Phase 4: Log Analysis | ⏳ Bekliyor | - | - |
